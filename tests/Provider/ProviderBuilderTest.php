<?php

declare(strict_types=1);

namespace Kefzce\CryptoCurrencyExchanges\Tests\Provider;

use GuzzleHttp\Client;
use Kefzce\CryptoCurrencyExchanges\DependencyInjection\ContainerBuilder\ContainerBuilder;
use Kefzce\CryptoCurrencyExchanges\Environment;
use Kefzce\CryptoCurrencyExchanges\Provider\CoinbaseProvider;
use Kefzce\CryptoCurrencyExchanges\Provider\HttpClient;
use Kefzce\CryptoCurrencyExchanges\Provider\NullProvider;
use Kefzce\CryptoCurrencyExchanges\Provider\ProviderBuilder;
use Kefzce\CryptoCurrencyExchanges\Provider\ProviderInterface;
use function Kefzce\CryptoCurrencyExchanges\removeDirectory;
use Kefzce\CryptoCurrencyExchanges\Tests\Provider\Stubs\AnotherInvalidProvider;
use Kefzce\CryptoCurrencyExchanges\Tests\Provider\Stubs\InvalidProvider;
use PHPUnit\Framework\TestCase;
use Symfony\Component\DependencyInjection\ContainerInterface;
use Symfony\Component\DependencyInjection\Exception\ServiceNotFoundException;

/** @noinspection PhpUndefinedClassInspection */
class ProviderBuilderTest extends TestCase
{
    /**
     * @var string
     */
    private $cacheDirectory;

    public function setUp()
    {
        parent::setUp();
        $this->cacheDirectory = sys_get_temp_dir() . '/provider_test';

        if (false === file_exists($this->cacheDirectory)) {
            mkdir($this->cacheDirectory);
        }
    }

    public function tearDown()
    {
        parent::tearDown();

        unset($this->cacheDirectory);
        parent::tearDown(); // TODO: Change the autogenerated stub
    }

    /**
     * @dataProvider correctProviderList
     *
     * @param ProviderInterface $provider
     */
    public function testCanCreateProviderBuilder($provider): void
    {
        $containerBuilder = new ContainerBuilder(Environment::create('providertest'));

        $containerBuilder->setCacheDirectoryPath($this->cacheDirectory);

        /** @var ContainerInterface $container */
        $container = $containerBuilder->build();
        $container->set(ProviderBuilder::class, new ProviderBuilder($container));
        $container->set((string) $provider, $provider);

        $builder = $container->get(ProviderBuilder::class);
        $provider = $builder->build(
            (string) $provider
        );

        $this->assertNotEmpty($provider);
        $this->assertInstanceOf(ProviderInterface::class, $provider);

        @unlink(sys_get_temp_dir() . '/provider_test');
        removeDirectory(sys_get_temp_dir() . '/provider_test');
    }

    /**
     * @dataProvider incorrectProviderList
     *
     * @param $provider
     */
    public function testShouldThrowExceptionIfProviderNotRegisterOnContainer($provider): void
    {
        $this->expectException(ServiceNotFoundException::class);
        $containerBuilder = new ContainerBuilder(Environment::create('providertest'));

        $containerBuilder->setCacheDirectoryPath($this->cacheDirectory);

        /** @var ContainerInterface $container */
        $container = $containerBuilder->build();
        $container->set(ProviderBuilder::class, new ProviderBuilder($container));

        $builder = $container->get(ProviderBuilder::class);
        $provider = $builder->build(
            (string) $provider
        );

        $this->assertNotEmpty($provider);
        $this->assertNotInstanceOf(ProviderInterface::class, $provider);

        @unlink(sys_get_temp_dir() . '/provider_test');
        removeDirectory(sys_get_temp_dir() . '/provider_test');
    }

    /** @noinspection PhpUndefinedClassInspection */
    public function correctProviderList(): ?\Generator
    {
        yield [new NullProvider()];

        yield [new CoinbaseProvider(new HttpClient(new Client()))];
    }

    /** @noinspection PhpUndefinedClassInspection */
    public function incorrectProviderList(): ?\Generator
    {
        yield [new AnotherInvalidProvider()];

        yield [new InvalidProvider()];
    }
}
